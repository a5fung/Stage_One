<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stage One</title>
  <link rel="stylesheet" href="style.css">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <!-- Catch any JS errors that would silently kill the button -->
  <script>
    window.addEventListener('error', function(e) {
      const el = document.getElementById('jsError');
      if (el) el.textContent = 'Error: ' + e.message + ' (' + (e.filename||'').split('/').pop() + ':' + e.lineno + ')';
      if (el) el.style.display = 'block';
    });
    window.addEventListener('unhandledrejection', function(e) {
      const el = document.getElementById('jsError');
      if (el) el.textContent = 'Error: ' + (e.reason && e.reason.message ? e.reason.message : e.reason);
      if (el) el.style.display = 'block';
    });
  </script>
</head>
<body>
  <!-- Error display (hidden unless JS throws) -->
  <div id="jsError" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#f44;color:#fff;padding:10px;font-family:monospace;font-size:13px;z-index:9999;word-break:break-all;"></div>

  <canvas id="gameCanvas"></canvas>

  <!-- MENU SCREEN -->
  <div id="menuScreen">
    <div class="menu-title">STAGE ONE</div>
    <div class="menu-subtitle">5v5 BOMB DEFUSAL</div>
    <div id="loadingMsg" style="color:#888;font-family:monospace;letter-spacing:3px;font-size:13px;margin-bottom:16px;">LOADING...</div>
    <button id="startBtn" class="menu-btn" style="display:none">CLICK TO PLAY</button>
    <button id="helpBtn" class="menu-btn-secondary" style="display:none">HOW TO PLAY</button>
    <div class="menu-hint">WASD / Arrow Keys — Move &nbsp;|&nbsp; Mouse — Look &nbsp;|&nbsp; LMB — Shoot &nbsp;|&nbsp; R — Reload &nbsp;|&nbsp; E — Interact</div>
    <div class="menu-hint" style="margin-top:6px;">Mobile: Joystick (left) — Move &nbsp;|&nbsp; Swipe (right) — Look &nbsp;|&nbsp; Fire button — Shoot</div>
  </div>

  <!-- HELP / HOW TO PLAY OVERLAY -->
  <div id="helpScreen" class="hidden">
    <div class="help-inner">
      <div class="help-title">HOW TO PLAY</div>

      <div class="help-section">
        <div class="help-section-title">OBJECTIVE</div>
        <p>Find the 4-digit code notes hidden by enemy agents. Enter the code at the enemy bomb to defuse it — before your own bomb explodes.</p>
      </div>

      <div class="help-columns">
        <div class="help-col">
          <div class="help-section-title">PHASES</div>
          <div class="help-row"><span class="help-tag hide-tag">HIDE</span><span>60 seconds. Enemy bots hide code notes around the map. Explore but don't shoot yet.</span></div>
          <div class="help-row"><span class="help-tag main-tag">MAIN</span><span>15 minutes. Hunt for notes, cross the map, enter the code at the enemy bomb.</span></div>

          <div class="help-section-title" style="margin-top:18px;">WIN CONDITIONS</div>
          <div class="help-row"><span class="help-icon">✓</span><span>Enter the correct code at the <strong>enemy bomb</strong></span></div>
          <div class="help-row"><span class="help-icon">✓</span><span>Enemy bomb timer reaches <strong>0:00</strong></span></div>

          <div class="help-section-title" style="margin-top:18px;">LOSE CONDITIONS</div>
          <div class="help-row"><span class="help-icon lose">✗</span><span>Your team's bomb timer hits <strong>0:00</strong></span></div>
          <div class="help-row"><span class="help-icon lose">✗</span><span>An enemy agent defuses <strong>your bomb</strong></span></div>
          <div class="help-row"><span class="help-icon lose">✗</span><span>You are <strong>eliminated</strong> (HP reaches 0)</span></div>
        </div>

        <div class="help-col">
          <div class="help-section-title">DESKTOP CONTROLS</div>
          <div class="help-key-row"><kbd>W A S D</kbd><span>Move</span></div>
          <div class="help-key-row"><kbd>Mouse</kbd><span>Look</span></div>
          <div class="help-key-row"><kbd>LMB</kbd><span>Shoot</span></div>
          <div class="help-key-row"><kbd>R</kbd><span>Reload</span></div>
          <div class="help-key-row"><kbd>E</kbd><span>Pick up note / Defuse bomb</span></div>
          <div class="help-key-row"><kbd>Click canvas</kbd><span>Lock cursor</span></div>
          <div class="help-key-row"><kbd>ESC</kbd><span>Unlock cursor / Cancel defuse</span></div>

          <div class="help-section-title" style="margin-top:18px;">MOBILE / IPAD CONTROLS</div>
          <div class="help-key-row"><span class="help-ctrl">Left joystick</span><span>Move</span></div>
          <div class="help-key-row"><span class="help-ctrl">Swipe right side</span><span>Look</span></div>
          <div class="help-key-row"><span class="help-ctrl">FIRE button</span><span>Shoot</span></div>
          <div class="help-key-row"><span class="help-ctrl">R button</span><span>Reload</span></div>
          <div class="help-key-row"><span class="help-ctrl">E button</span><span>Interact</span></div>
        </div>
      </div>

      <div class="help-section" style="margin-top:18px;">
        <div class="help-section-title">TIPS</div>
        <div class="help-row"><span class="help-icon">→</span><span>Code notes glow and float — look for yellow light near boxes and corridors</span></div>
        <div class="help-row"><span class="help-icon">→</span><span>Your friendly bots will fight enemies — use them as cover while you find notes</span></div>
        <div class="help-row"><span class="help-icon">→</span><span>The enemy bomb is in the far base (north end of map). Your bomb is south.</span></div>
        <div class="help-row"><span class="help-icon">→</span><span>You only need ONE collected code to defuse. Multiple notes give backup codes.</span></div>
      </div>

      <button id="helpCloseBtn" class="menu-btn" style="margin-top:28px;">BACK TO MENU</button>
    </div>
  </div>

  <!-- PHASE BANNER -->
  <div id="phaseBanner" class="hidden"></div>

  <!-- TOP HUD -->
  <div id="topHud" class="hidden">
    <div id="teamBombTimer" class="bomb-timer team-timer">
      <span class="timer-label">TEAM BOMB</span>
      <span id="teamBombTime">15:00</span>
    </div>
    <div id="enemyBombTimer" class="bomb-timer enemy-timer">
      <span class="timer-label">ENEMY BOMB</span>
      <span id="enemyBombTime">15:00</span>
    </div>
  </div>

  <!-- BOTTOM HUD -->
  <div id="bottomHud" class="hidden">
    <div id="hpSection">
      <span class="hud-label">HP</span>
      <div id="hpBar"><div id="hpFill"></div></div>
      <span id="hpNum">200</span>
    </div>
    <div id="ammoSection">
      <span id="ammoCount">50</span>
      <span class="hud-label">/∞</span>
      &nbsp;&nbsp;
      <span class="hud-label">[R]=RELOAD</span>
    </div>
  </div>

  <!-- CROSSHAIR -->
  <div id="crosshair" class="hidden">+</div>

  <!-- HIT MARKER -->
  <div id="hitMarker" class="hidden">✕</div>

  <!-- DAMAGE VIGNETTE -->
  <div id="damageVignette"></div>

  <!-- PHASE TIMER (HIDE phase countdown) -->
  <div id="phaseTimer" class="hidden"></div>

  <!-- NOTIFICATION POPUP (code found, etc.) -->
  <div id="notification" class="hidden"></div>

  <!-- CODE PANEL (bomb defuse input) -->
  <div id="codePanel" class="hidden">
    <div class="code-panel-title">ENTER DEFUSE CODE</div>
    <div class="code-panel-hint">Type 4 digits then press ENTER</div>
    <div id="codeInputDisplay">
      <span class="code-digit" id="cd0">_</span>
      <span class="code-digit" id="cd1">_</span>
      <span class="code-digit" id="cd2">_</span>
      <span class="code-digit" id="cd3">_</span>
    </div>
    <div id="codeError" class="hidden">WRONG CODE</div>
    <div class="code-panel-hint" style="margin-top:12px;">ESC to cancel</div>
    <!-- Mobile number pad -->
    <div id="mobileNumpad">
      <button class="numpad-btn" data-digit="1">1</button>
      <button class="numpad-btn" data-digit="2">2</button>
      <button class="numpad-btn" data-digit="3">3</button>
      <button class="numpad-btn" data-digit="4">4</button>
      <button class="numpad-btn" data-digit="5">5</button>
      <button class="numpad-btn" data-digit="6">6</button>
      <button class="numpad-btn" data-digit="7">7</button>
      <button class="numpad-btn" data-digit="8">8</button>
      <button class="numpad-btn" data-digit="9">9</button>
      <button class="numpad-btn numpad-clear" data-digit="clear">⌫</button>
      <button class="numpad-btn" data-digit="0">0</button>
      <button class="numpad-btn numpad-enter" data-digit="enter">ENTER</button>
    </div>
  </div>

  <!-- COLLECTED CODES PANEL -->
  <div id="codesPanel" class="hidden">
    <div class="codes-title">COLLECTED CODES</div>
    <div id="codesList"></div>
  </div>

  <!-- END SCREEN -->
  <div id="endScreen" class="hidden">
    <div id="endTitle"></div>
    <div id="endSubtitle"></div>
    <button id="playAgainBtn" class="menu-btn">PLAY AGAIN</button>
  </div>

  <!-- MOBILE CONTROLS -->
  <div id="mobileControls" class="hidden">
    <!-- Left joystick -->
    <div id="joystickZone">
      <div id="joystickBase">
        <div id="joystickThumb"></div>
      </div>
    </div>
    <!-- Right look zone (swipe area) -->
    <div id="lookZone"></div>
    <!-- Fire button -->
    <button id="fireBtn">FIRE</button>
    <!-- Interact button -->
    <button id="interactBtn">E</button>
    <!-- Reload button -->
    <button id="reloadBtn">R</button>
  </div>

  <!-- INTERACT PROMPT -->
  <div id="interactPrompt" class="hidden">[E] Interact</div>

  <script type="module" src="js/main.js"></script>
</body>
</html>
